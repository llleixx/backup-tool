name: Release Backup Tool

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Verify version consistency
        run: |
          # Extract version from the Git tag
          TAG_VERSION="${{ github.ref_name }}"
          
          # Extract version from lib/config.sh, assuming it's defined like: readonly VERSION="X.Y.Z"
          # If your version variable or file is different, adjust the grep command accordingly.
          CONFIG_VERSION=$(grep -oP 'readonly VERSION="\K[^"]+' lib/config.sh)
          
          echo "Git Tag Version: $TAG_VERSION"
          echo "Config File Version: v$CONFIG_VERSION"
          
          if [ "$CONFIG_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Version in lib/config.sh ($CONFIG_VERSION) does not match Git tag ($TAG_VERSION)."
            exit 1
          fi

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
